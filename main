import discord, os, dotenv, deck_of_cards, Player, Dealer, Game, EmptyLobbyException
from Player import Player
from discord.ext.commands import Bot
from dotenv import load_dotenv
from deck_of_cards import deck_of_cards

# Discord Auth/Bot Logistics
bot = Bot(command_prefix="*")
load_dotenv(".env")
TOKEN = os.getenv("TOKEN")

# game fields
game = None

try:
    game = Game.Game(bot)
except EmptyLobbyException:
    print(bot)

@bot.command(name='test')
async def test_command(message):
    await message.channel.send("Test Received!")

# STARTS A NEW BLACKJACK GAME
@bot.command(name='start')
async def start(message):
    global game
    game = Game.Game(bot)
    game.start()
    await message.channel.send("Welcome to BlackJack! Use *join to have a seat at the table!")

'''
Begin differs from start as it is used to begin a round. This is used at the very beginning of the
game OR when someone joins the table via "*join". Begin must be used once everyone is done joining the
table. Being is only neccesary when > 1 person/people join the table.
'''
@bot.command(name='begin')
async def begin(message):
    global game
    game.begin(message)
    await message.channel.send("Starting the game with the current players:\n{}".format(str(game)))
    await message.channel.send("{}, it is your turn!".format(str(game.curr_player.username)))

@bot.command(name='join')
async def join(message):
    global game
    game.add_player(Player(str(message.author)))
    await message.channel.send("{} has joined the table!\n{}".format(message.author, game))

@bot.command(name='hit')
async def hit(message):
    global game
    player = game.curr_player
    if player.disc_username.strip() != str(message.author).strip():
        await message.channel.send("{}, it is {}'s turn!".format(message.author, str(player.disc_username)))
    if not game.hit(message):
        await message.channel.send("{} bust with {}!".format(str(message.author), player.count))
        await message.channel.send("{}, it is your turn!".format(game.next_player))
    else:
        await message.channel.send("{}, your new hand is {} for a total of {}. Would you like to hit or stand?".format(player.get_username(), player.cards_str(), str(player.count)))
    game.next_turn(message)

@bot.command(name='stand')
async def stand(message):
    global game
    player = game.curr_player
    if player.disc_username == message.author:
        await message.channel.send("{}, it is {}'s turn!".format(message.author, str(player.disc_username)))
    else:
        await message.channel.send("{}, it is your turn!".format(message.author))
    game.deal([player])

@bot.command(name='leave')
async def leave(message):
    global game
    game.remove_player(str(message.author))
    await message.channel.send("{} has left the table. Thanks for Playing!".format(message.author))

@bot.command(name='table')
async def table(message):
    global game
    await message.channel.send("{}".format(str(game)))

print(TOKEN)
bot.run(TOKEN)